import requests
from openpyxl import Workbook

url = "https://api_proxy.datadog/.../api/v2/spans/events/search"

payload = {
    "data": {
        "attributes": {
            "filter": {
                "from": "now-15m",
                "query": "service:ttk-service-bla",
                "to": "now"
            },
            "page": {"limit": 100},
            "sort": "timestamp"
        },
        "type": "search_request"
    }
}

headers = {
    "DD-API-KEY": "org-***",
    "DD-APPLICATION-KEY": "org-***",
    "Content-Type": "application/json"
}

data = response.json()

def extrair_status_code(attrs):
    """Tenta pegar o status_code de várias formas possíveis"""

    # 1. nível direto
    if "status_code" in attrs:
        return attrs["status_code"]

    # 2. em attributes.http.status_code
    try:
        return attrs["attributes"]["http"]["status_code"]
    except:
        pass

    # 3. em metadata.status_code
    try:
        return attrs["metadata"]["status_code"]
    except:
        pass

    # 4. em attribute http.status_code
    if "http.status_code" in attrs:
        return attrs["http.status_code"]

    # 5. tags com http.status_code:###
    tags = attrs.get("tags", [])
    if isinstance(tags, list):
        for t in tags:
            if t.startswith("http.status_code:"):
                return t.split(":")[1]

    return None  # nada encontrado

# === Parse dos resultados ===
registros = []

for item in data.get("data", []):
    attrs = item.get("attributes", {})
    status = extrair_status_code(attrs)

    registros.append({
        "status_code": status,
        "message": attrs.get("message"),
    })

# Exportar para Excel
df = pd.DataFrame(registros)
df.to_excel("output.xlsx", index=False)

print("output.xlsx gerado.")
