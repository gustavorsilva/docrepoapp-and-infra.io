from datadog_api_client.v2 import ApiClient, Configuration
from datadog_api_client.v2.api.logs_api import LogsApi
import pandas as pd
import os

configuration = Configuration()

configuration.servers = [{"url": "https://api.datadoghq.com"}]

configuration.api_key["apiKeyAuth"] = os.getenv("DATADOG_API_KEY")
configuration.api_key["appKeyAuth"] = os.getenv("DATADOG_APP_KEY")

SERVICE_NAME = "meu-servico"

query = f"service:{SERVICE_NAME} @error:true @trace_id:*"

body = {
    "filter": {
        "query": query,
        "from": "now-24h",
        "to": "now"
    },
    "sort": "timestamp",
    "page": {"limit": 1000}
}

with ApiClient(configuration) as api_client:
    api_instance = LogsApi(api_client)
    response = api_instance.list_logs(body=body)

spans = [item.attributes for item in response.data]

rows = []
for span in spans:
    service = span.get("service", "")
    resource = span.get("resource", "")
    http_status = None

    tags = span.get("tags", [])
    for tag in tags:
        if tag.startswith("http.status_code:"):
            http_status = tag.split(":")[1]

    rows.append({
        "service": service,
        "resource": resource,
        "status_code": http_status
    })

df = pd.DataFrame(rows)
df.to_csv("traces_erros_output.csv", index=False)

print("Arquivo gerado com sucesso: traces_erros_output.csv")
