import requests
from openpyxl import Workbook

url = "https://api_proxy.datadog/.../api/v2/spans/events/search"

payload = {
    "data": {
        "attributes": {
            "filter": {
                "from": "now-15m",
                "query": "service:ttk-service-bla",
                "to": "now"
            },
            "page": {"limit": 100},
            "sort": "timestamp"
        },
        "type": "search_request"
    }
}

headers = {
    "DD-API-KEY": "org-***",
    "DD-APPLICATION-KEY": "org-***",
    "Content-Type": "application/json"
}

response = requests.post(url, json=payload, headers=headers)

## new
print("HTTP Status:", response.status_code)

data = response.json()

# === Parse dos resultados ===
registros = []

for item in data.get("data", []):
    attrs = item.get("attributes", {})

    # Pegar status_code interno do log
    status_json = attrs.get("status_code")

    # Converter string → número
    if status_json is not None:
        try:
            status_json = int(status_json)
        except:
            pass

    registros.append({
        "status_code": status_json,
        "message": attrs.get("message")
    })

# === Exportar para Excel ===
df = pd.DataFrame(registros)
df.to_excel("output.xlsx", index=False)

print("Arquivo 'output.xlsx' gerado com sucesso!")
