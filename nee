# --- Execução da Requisição ---
print("Iniciando busca por traces no Datadog...")

try:
    # A API espera o payload no corpo da requisição, que será serializado como JSON
    response = requests.post(url, headers=headers, json=payload)
    response.raise_for_status() # Lança uma exceção para códigos de status HTTP ruins (4xx ou 5xx)

    data = response.json()
    print(f"Status da Resposta: {response.status_code}")

    # --- Processamento dos Dados ---
    traces_list = []

    # O objeto de resposta do Datadog tem uma chave 'data' que é uma lista de spans (traces)
    if 'data' in data and data['data']:
        print(f"Traces encontrados: {len(data['data'])}")

        for trace_event in data['data']:
            # Extraindo atributos chave. A estrutura de um span/trace é complexa.
            # Aqui estamos extraindo o trace_id e o service.
            attributes = trace_event.get('attributes', {})
            
            traces_list.append({
                'id': trace_event.get('id'), # ID do span/evento
                'type': trace_event.get('type'),
                'trace_id': attributes.get('trace_id'),
                'service': attributes.get('service'),
                'name': attributes.get('name'),
                'status': attributes.get('status'),
                'duration_ns': attributes.get('duration'),
                'timestamp': attributes.get('timestamp')
            })

        # Criação do DataFrame
        df_traces = pd.DataFrame(traces_list)

        print("\n--- DataFrame Gerado ---")
        print(df_traces[['trace_id', 'service', 'name', 'status', 'timestamp']].head())
        print(f"\nTotal de linhas no DataFrame: {len(df_traces)}")

        # Exemplo de como salvar em CSV
        # df_traces.to_csv("datadog_traces_export.csv", index=False)
        # print("\nDados exportados para datadog_traces_export.csv")

    else:
        print("Nenhum trace encontrado com o filtro especificado.")
        print(data) # Imprime a resposta completa para depuração
        
except requests.exceptions.HTTPError as errh:
    print(f"Erro HTTP: {errh}")
    print(f"Resposta de erro: {response.text}")
except requests.exceptions.ConnectionError as errc:
    print(f"Erro de Conexão: {errc}")
except requests.exceptions.Timeout as errt:
    print(f"Timeout: {errt}")
except requests.exceptions.RequestException as err:
    print(f"Ocorreu um erro: {err}")
