import requests
import re
import pandas as pd

url = "https://api.proxy.datadog/api/v2/spans/events/search"

payload = {
    "data": {
        "attributes": {
            "filter": {
                "query": "service:ttk-service-bla",
                "from": "now-15m",
                "to": "now",
            },
            "page": {"limit": 100},
            "sort": "timestamp"
        },
        "type": "search_request"
    }
}

headers = {
    "DD-API-KEY": "org-...",
    "DD-APPLICATION-KEY": "org-...",
    "Content-Type": "application/json"
}

# --- 2. EXECUÇÃO DA REQUISIÇÃO ---
try:
    response = requests.post(url, json=payload, headers=headers)
    response.raise_for_status() # Lança exceção para códigos de status HTTP 4xx/5xx
    raw_text = response.text
except requests.exceptions.RequestException as e:
    print(f"Erro na requisição à API do Datadog: {e}")
    raw_text = ""
    
if not raw_text:
    print("Não foi possível obter a resposta da API. Encerrando.")
    exit()

# --- 3. EXTRAÇÃO DE TODOS OS CAMPOS USANDO REGEX ---
# O padrão r'"campo"\s*:\s*"([^"]+)"' captura o valor dentro das aspas após a chave "campo"
status_codes = re.findall(r'"status_code"\s*:\s*"(\d+)"', raw_text)
messages = re.findall(r'"mensagem"\s*:\s*"([^"]+)"', raw_text)

resource_names = re.findall(r'"resource_name"\s*:\s*"([^"]+)"', raw_text)
paths = re.findall(r'"path"\s*:\s*"([^"]+)"', raw_text)
dates = re.findall(r'"date"\s*:\s*"([^"]+)"', raw_text)
funcionais = re.findall(r'"funcional"\s*:\s*"([^"]+)"', raw_text)


rows = []

# --- 4. LÓGICA DE FILTRAGEM (GARANTIA DE TODOS OS VALORES) ---

# Encontrar o tamanho da menor lista para garantir que todos os 6 campos
# existam para o registro que está sendo criado.
min_len = min(
    len(status_codes),
    len(messages),
    len(resource_names),
    len(paths),
    len(dates),
    len(funcionais)
)

print(f"Número de registros completos (onde os 6 campos foram encontrados): {min_len}")

# Iterar apenas até o tamanho da menor lista
for i in range(min_len):
    rows.append({
        "status_code": status_codes[i],
        "mensagem": messages[i],
        "resource_name": resource_names[i],
        "path": paths[i],
        "date": dates[i],
        "funcional": funcionais[i]
    })

# --- 5. GERAÇÃO DO DATAFRAME E ARQUIVO FINAL ---
df = pd.DataFrame(rows)

df.to_excel("resultado_completo_filtrado.xlsx", index=False)

print("\n### DataFrame com Linhas Preenchidas (6 Colunas) ###")
print(df.head())
print(f"\nTotal de linhas no DataFrame final: {len(df)}")
print("\nArquivo gerado: resultado_completo_filtrado.xlsx")
